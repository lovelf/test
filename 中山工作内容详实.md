## 目录
- <a href="#2016-07-01">2016-07-01</a>
- <a href="#2016-07-05">2016-07-05</a>

------

### <span id="2016-07-01">周五 2016/07/01 晴</span>
- 早上坐车从深圳宝安到中山融昊创意园，路途漫长不能一一言尽，但是宝安出发的车很难。
- 对接sso获取用用户（主账号信息） 和 customer code, 扣费对接
-  root asdasd123 172.18.1.60 2219
- 测试获取账号信息

------------

```  
<?php

    $url= 'http://183.57.41.211/coreservice/account/getaccountbyloginid';
    $method='post';    
    $arr = array(
        'nonceToken'=> time(),
        'operatorId' => -99999,
        'loginId' => 'admin',
        'language' => 'en-us',
        'data' => 'admin',
        'asyncRequest'=> false
    );
    
    $arr = json_encode($arr);  
    
    curl($url,$arr,$method);
          
    function curl($url,$post_data,$method='get') {
       $ch = curl_init();
       curl_setopt($ch, CURLOPT_URL, $url);
       
       // post数据
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, 1);
           // post的变量           
        curl_setopt($ch, CURLOPT_POSTFIELDS, $post_data);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt ($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type:application/json', 'Charset:UTF-8'));
        $output = curl_exec($ch);
        curl_close($ch);
        //打印获得的数据
        print_r($output);
    }
    
?>
```

----------------------   

- 保存sso用户， firstname为user， 保存用户的id，parent_id,customer_code,
- sisiusa  asdasd123 副账号的id
- 理清分销单 预定单思路
- 分销单 --- 冻结资金（生产分销单->冻结资金->出库完成->扣费成功）（共享库存）
- 预订单 --- 冻结资金为0
- 分销单 预订单加上供应商供货价
-  嵌入样式
- 修改预订单 增加供货价、 对接扣费成功 获取产品价格实时的价格


### 尝试

```javascript

var canvas = document.getElementById("canvas");

var context = canvas.getContext("2d");

```

### checkout分析
- 考虑了minimum
- tax 考虑了
- total采用order的extensions->total
- booking_order字段

  字段 | 取值
  ----|---
  order_sn | 系统生成
  invoice_prefix | 取用配置里的
  store_id | 
  store_name| 
  store_url | 
  customer_id|
  customer_group_id|
  customer_field|
  language_id|
  currency_id|
  currency_code|
  currency_value|
  forwarded_ip|
  user_agent|
  accept_language|
  
- **处理cart取用的价格和供货价**  <span color="#e7e7e7"> ok </span>
- 扣费接口对接 ---

```json
   {
       "errors":null,
       "data":       
       {   
           "billingAmount":-20000.0,
           "currencyCode":"USD",
           "currencyCodeLabel":"美元",
           "billingItemCode":"distribution"
       },
       "nonceToken":null,
       "errorsToString":""
   }
```
分析errors是否只有null时才为成功的


### 2016-07-04 雨后天晴 气候适宜 精神充沛
- 修改分销单关联仓库 和 供货价
- 调整分销单api
- 增加扣费接口 冻结 和 确认
- v5预扣费陈述

> v5系统存在原有预扣费接口，和预扣费解除接口。但是没有确定扣费接口，它是默认扣费成功的，当执行预扣费解除接口时可以退款。 对于我们的业务来说，当发货成功时 不做任何操作， 当发货不成功时 通知你解除预扣费。
- 增加结算接口 产品字段里有

  参数 | 描述
  ---| ---
  sku | 分销sku
  quantity | 产品数量
  price | 产品价格
  supplier_price|供货价（分销商不能看到，运营能看到）
  order_sn | 分销单号
  currency_code | 币种

- 计算公式 单个产品的公式 quantity*price
- 订单
- **bug 预订单下单时库存不够**
- 修改订单api

```sql
ALTER TABLE `order_product` ADD COLUMN `warehouse_id`  int(11) NOT NULL COMMENT '仓库id' AFTER `sku`;
ALTER TABLE `order_product` ADD COLUMN `supplier_price`  decimal(15,4) NOT NULL DEFAULT 0.0000 COMMENT '供货价' AFTER `warehouse_id`;
```
- 订单添加所需字段

  传输参数 | 描述
  --- | ---
  买家id | 主账号id
  发货地址| 收件地址
  收件人| 
  产品信息|
  sku | 
  warehouse_code |
  quantity | 
  order_sn |  
  
- 原有的customer验证，payment Address， products，product items详情， shipping， 
- 增加account_id 分析
- products验证

  参数 | 是否必须| 字段类型| 长度| 描述
  ---| ---|---|:---|:---
  sku|Y | varchar | 64 | 分销sku
  quantity | Y| int | 11| 产品数量
  warehouse_code | Y | varchar | 10 | 仓库code
  booking_order_sn | N | varchar | 64 | 若是从预订单里发货则取用此订单号传递，若是采用共享库存，则为空。
- 查询产品是否存在
```php
$product_query = $this->db->query(
    "SELECT * FROM " . DB_PREFIX . "product_to_store p2s 
    LEFT JOIN " . DB_PREFIX . "product p ON (p2s.product_id = p.product_id) 
    LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) 
    WHERE p2s.store_id = '" . (int) $this->config->get('config_store_id') . "' AND p2s.product_id = '" . (int) $data['product_id'] . "' 
    AND pd.language_id = '" . (int) $this->config->get('config_language_id') . "' AND p.date_available <= NOW() 
    AND p.status = '1'");
```
考虑了 store_id, product_id(改为sku），pd.language_id, data_available, p.status

### 2016-07-05 中山 以晴为主 偶尔阵雨 大事记
- 检查库存 warehouse_code, order_sn
- shipping 参数

  字段 | 描述
  --- | ---
  shipping_firstname | 
  shipping_lastname |
  shipping_company | 
  shipping_address1 |
  shipping_address2 |
  shipping_city |
  shipping_postcode |
  shipping_country |
  shipping_country_id |
  shipping_zone |
  shipping_zone_id  |
  shipping_address_format |
  shipping_method | 

customer参数
  
  参数 | 描述
   ---| ---
  firstname | 首名称
  lastname | 姓
  email | 邮箱
  telephone | 电话
  fax | fax
  
- 付款地址不用考虑
- shipping地址考虑
- products
  

- 分销单订单状态
-  
  状态 | 描述
   --- | ---
  1  | 为结算成功 
  1  | 结算成功
  3  | 确认发货
  4  | 发货失败

- 分销单添加的测试代码

```php 
  array(
      'account_id' => 107,
      'shipping' => array(
          'firstname' => 'bin',
          'lastname'  => 'zhai',
          'company'   => 'edayun',
          'address_1' => 'shenzhen',
          'address_2' => 'nanshanqu',
          'city'      => 'shenzhen',
          'postcode'  => '2000',
          'country'   => 'china',
          'method'    => 'shipping',
          'code'      => 'USPS'
       ),
       'customer' => array(
           'firstname' => 'binzhai',
           'lastname'  => 'bin',
           'email'     => 'wendellzhaibin@gmail.com',
           'telephone' => '199887666',
           'fax'       => '2928727'
       ),
       'products' => array(
            array(
                'sku' => 'GROB-TN360-BZ03',
                'warehouse_code' => 'AW',
                'quantity' => 10
            )
      )
  )
```
- 在获取预订单的产品数量是应该增加出库的判断 
- api状态分析

   状态 | 描述
   ---| ---
   0 | 成功 success
   1 | 内容报错 fail
   2 | fail token token无效
   3 | fail_sign sign验证失败
   4 | fail_data_decode data解密失败
   5 | fail_verify_sign 验证签名失败
   6 | fail_api_id ip验证失败
   7 | fail_api_version api版本验证失败
   8 | error_verify_key 

- 对接结算费接口
- 增加两个接口 发货成功接口和失败接口
  